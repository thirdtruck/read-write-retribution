#!/usr/bin/env ruby

require 'sinatra'
require 'mongoid'
require './lib/mongo-if'

def setup_sinatra
  port = ARGV[0] ? ARGV[0].to_i : 4567
  set :port, port
end

def setup_mongodb
  if ENV['MONGOLAB_URI']
    Mongoid.load!("config/heroku.yml")
  else
    Mongoid.load!("config/mongoid.yml")
    Mongoid.logger = Logger.new($stdout)
    Mongoid.logger.level = Logger::DEBUG
    Moped.logger = Logger.new($stdout)
    Moped.logger.level = Logger::DEBUG
  end
end

def initialize_pages
  MongoIF::Page.where({}).delete # Empty the collection before rebuilding it

  Dir.glob('pages/*.txt') do |page_file|
    page = MongoIF::Page.from_file(page_file)
    page.save
  end
end

setup_sinatra
setup_mongodb

initialize_pages

get '/' do
  redirect to('/start')
end

get '/:page' do |page_identifier|
  page = MongoIF::Page.where(identifier: page_identifier).first
  pass unless page

  page.tokens = page.tokens.map(&:degraded)
  page.save
  page.tokens.map(&:render).join('')
end

